<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Notifications Example</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .notification {
            background: #f0f8ff;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .notification.unread {
            background: #fff3cd;
            border-color: #ffeaa7;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.connected {
            background: #d4edda;
            color: #155724;
        }
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        .controls {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        button {
            padding: 8px 16px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .connect-btn {
            background: #28a745;
            color: white;
        }
        .disconnect-btn {
            background: #dc3545;
            color: white;
        }
        .test-btn {
            background: #007bff;
            color: white;
        }
    </style>
</head>
<body>
    <h1>Real-time Notifications Demo</h1>
    
    <div class="controls">
        <label for="userId">User ID:</label>
        <input type="text" id="userId" value="3312edf0-2443-48a0-9d57-bda90e5bfb4c" style="width: 300px;">
        <button class="connect-btn" onclick="connect()">Connect</button>
        <button class="disconnect-btn" onclick="disconnect()">Disconnect</button>
        <button class="test-btn" onclick="testNotification()">Test Notification</button>
    </div>

    <div id="status" class="status disconnected">
        Status: Disconnected
    </div>

    <h2>Notifications</h2>
    <div id="notifications"></div>

    <script>
        let ws = null;
        let isConnected = false;

        function connect() {
            const userId = document.getElementById('userId').value;
            if (!userId) {
                alert('Please enter a User ID');
                return;
            }

            const wsUrl = `ws://localhost:4009?userId=${userId}`;
            ws = new WebSocket(wsUrl);

            ws.onopen = function() {
                isConnected = true;
                updateStatus('Connected', 'connected');
                console.log('WebSocket connected');
            };

            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                console.log('Received message:', data);

                if (data.type === 'connection') {
                    updateStatus('Connected - ' + data.message, 'connected');
                } else if (data.type === 'notification') {
                    addNotification(data.data);
                } else if (data.type === 'pong') {
                    console.log('Pong received');
                }
            };

            ws.onclose = function(event) {
                isConnected = false;
                updateStatus('Disconnected', 'disconnected');
                console.log('WebSocket disconnected:', event.code, event.reason);
            };

            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
                updateStatus('Connection Error', 'disconnected');
            };
        }

        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        function updateStatus(message, className) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = 'Status: ' + message;
            statusDiv.className = 'status ' + className;
        }

        function addNotification(notification) {
            const notificationsDiv = document.getElementById('notifications');
            const notificationDiv = document.createElement('div');
            notificationDiv.className = 'notification unread';
            
            notificationDiv.innerHTML = `
                <h3>${notification.title}</h3>
                <p>${notification.message}</p>
                <small>
                    Type: ${notification.type} | 
                    Category: ${notification.category} | 
                    Time: ${new Date(notification.createdAt).toLocaleString()}
                </small>
            `;

            notificationsDiv.insertBefore(notificationDiv, notificationsDiv.firstChild);

            // Show browser notification
            if (Notification.permission === 'granted') {
                new Notification(notification.title, {
                    body: notification.message,
                    icon: '/favicon.ico'
                });
            }
        }

        function testNotification() {
            if (!isConnected) {
                alert('Please connect first');
                return;
            }

            // Send a test notification via API
            fetch('http://localhost:4009/notifications', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    userId: document.getElementById('userId').value,
                    type: 'TRANSACTIONAL',
                    category: 'SYSTEM',
                    title: 'ðŸ§ª Test Notification',
                    message: 'This is a test notification sent at ' + new Date().toLocaleString(),
                    metadata: { test: true }
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Test notification sent:', data);
            })
            .catch(error => {
                console.error('Error sending test notification:', error);
            });
        }

        // Request notification permission
        if ('Notification' in window) {
            Notification.requestPermission();
        }

        // Auto-connect on page load
        window.onload = function() {
            // Uncomment the line below to auto-connect
            // connect();
        };
    </script>
</body>
</html> 