# OTP Authentication System Documentation\n\n## Overview\n\nThis document describes the comprehensive OTP (One-Time Password) authentication system implemented for the 50Brains platform. The system provides secure email-based verification for various authentication scenarios.\n\n## Features\n\n### âœ… Implemented OTP Scenarios\n\n1. **Registration Verification** - Verify email during user registration\n2. **OTP Login** - Login using email + OTP (no password required)\n3. **Password Reset** - Reset forgotten password with OTP verification\n4. **Password Change** - Change password with OTP confirmation\n5. **Email Verification** - Verify email for existing users\n\n### ðŸ”§ System Components\n\n#### 1. OTP Utility (`src/utils/otp.utils.js`)\n- Secure OTP generation using crypto module\n- Database storage with hashed OTPs\n- Automatic expiration (10 minutes)\n- Rate limiting (max 3 attempts per 15 minutes)\n- Cleanup of expired/used OTPs\n\n#### 2. Email Service (`src/utils/email.utils.js`)\n- SMTP configuration with multiple provider support\n- Professional HTML email templates\n- Graceful fallback for development\n- Email delivery tracking\n\n#### 3. Email Templates (`src/templates/`)\n- `register.html` - Welcome and registration verification\n- `forgot-password.html` - Password reset request\n- `password-change.html` - Password change confirmation\n- `otp-login.html` - Login verification\n- `email-verification.html` - Email verification for existing users\n\n#### 4. Database Schema\n- `OTPRecord` model with purpose-based tracking\n- Indexed for performance\n- Automatic cleanup of expired records\n\n## API Endpoints\n\n### Registration Flow\n\n#### 1. Register User\n```http\nPOST /auth/register\nContent-Type: application/json\n\n{\n  \"email\": \"user@example.com\",\n  \"password\": \"SecurePass123!\",\n  \"username\": \"username\",\n  \"roles\": [\"USER\"]\n}\n```\n\n**Response:**\n```json\n{\n  \"success\": true,\n  \"user\": { ... },\n  \"message\": \"Registration successful! Please check your email for verification code.\",\n  \"otpSent\": true,\n  \"nextStep\": \"verify-registration-otp\"\n}\n```\n\n#### 2. Verify Registration OTP\n```http\nPOST /auth/verify-registration-otp\nContent-Type: application/json\n\n{\n  \"email\": \"user@example.com\",\n  \"otp\": \"123456\"\n}\n```\n\n**Response:**\n```json\n{\n  \"success\": true,\n  \"message\": \"Email verified successfully! You are now logged in.\",\n  \"user\": { ... },\n  \"tokens\": {\n    \"accessToken\": \"...\",\n    \"refreshToken\": \"...\"\n  }\n}\n```\n\n### OTP Login Flow\n\n#### 1. Initiate OTP Login\n```http\nPOST /auth/otp-login/initiate\nContent-Type: application/json\n\n{\n  \"email\": \"user@example.com\"\n}\n```\n\n#### 2. Complete OTP Login\n```http\nPOST /auth/otp-login/complete\nContent-Type: application/json\n\n{\n  \"email\": \"user@example.com\",\n  \"otp\": \"123456\"\n}\n```\n\n### Password Reset Flow\n\n#### 1. Request Password Reset\n```http\nPOST /auth/forgot-password\nContent-Type: application/json\n\n{\n  \"email\": \"user@example.com\"\n}\n```\n\n#### 2. Reset Password with OTP\n```http\nPOST /auth/reset-password\nContent-Type: application/json\n\n{\n  \"email\": \"user@example.com\",\n  \"otp\": \"123456\",\n  \"newPassword\": \"NewSecurePass123!\"\n}\n```\n\n### Password Change Flow (Authenticated)\n\n#### 1. Initiate Password Change\n```http\nPOST /auth/change-password/initiate\nAuthorization: Bearer <access_token>\nContent-Type: application/json\n\n{\n  \"currentPassword\": \"CurrentPass123!\"\n}\n```\n\n#### 2. Complete Password Change\n```http\nPOST /auth/change-password/complete\nAuthorization: Bearer <access_token>\nContent-Type: application/json\n\n{\n  \"otp\": \"123456\",\n  \"newPassword\": \"NewSecurePass123!\"\n}\n```\n\n### Email Verification Flow (Authenticated)\n\n#### 1. Send Verification OTP\n```http\nPOST /auth/email-verification/send\nAuthorization: Bearer <access_token>\n```\n\n#### 2. Verify Email with OTP\n```http\nPOST /auth/email-verification/verify\nAuthorization: Bearer <access_token>\nContent-Type: application/json\n\n{\n  \"otp\": \"123456\"\n}\n```\n\n## Configuration\n\n### Environment Variables\n\nAdd these variables to your `.env` file:\n\n```env\n# SMTP Configuration\nSMTP_HOST=smtp.gmail.com\nSMTP_PORT=587\nSMTP_SECURE=false\nSMTP_USER=your-email@gmail.com\nSMTP_PASS=your-app-password\nSMTP_FROM=no-reply@50brains.com\n\n# App Configuration\nAPP_NAME=50Brains\nCOMPANY_NAME=50Brains\nSUPPORT_EMAIL=support@50brains.com\n```\n\n### SMTP Provider Setup\n\n#### Gmail (Development)\n1. Enable 2-Factor Authentication\n2. Generate App Password: Google Account â†’ Security â†’ App passwords\n3. Use Gmail address as `SMTP_USER`\n4. Use app password as `SMTP_PASS`\n\n#### SendGrid (Production)\n```env\nSMTP_HOST=smtp.sendgrid.net\nSMTP_PORT=587\nSMTP_USER=apikey\nSMTP_PASS=your-sendgrid-api-key\n```\n\n#### Mailgun (Production)\n```env\nSMTP_HOST=smtp.mailgun.org\nSMTP_PORT=587\nSMTP_USER=your-mailgun-username\nSMTP_PASS=your-mailgun-password\n```\n\n## Database Migration\n\nRun the following to update your database schema:\n\n```bash\n# Generate Prisma client\nnpm run prisma:generate\n\n# Create and apply migration\nnpm run prisma:migrate\n```\n\n## Security Features\n\n### ðŸ”’ OTP Security\n- **Hashed Storage**: OTPs are hashed using SHA-256 before database storage\n- **Time-based Expiration**: 10-minute expiration window\n- **Attempt Limiting**: Maximum 3 verification attempts per OTP\n- **Rate Limiting**: 3 OTP requests per 15-minute cooldown period\n- **Purpose Isolation**: OTPs are purpose-specific and cannot be reused across different flows\n\n### ðŸ›¡ï¸ Email Security\n- **Template Validation**: XSS-safe template rendering\n- **SMTP Security**: TLS encryption for email transmission\n- **Graceful Degradation**: Fallback behavior when email service is unavailable\n- **Development Mode**: OTP visible in response during development (NODE_ENV=development)\n\n### ðŸš« Anti-Abuse Features\n- **Cooldown Periods**: Prevents rapid OTP requests\n- **Automatic Cleanup**: Expired and used OTPs are automatically removed\n- **Attempt Tracking**: Failed verification attempts are logged\n- **User Validation**: Comprehensive user state checking before OTP generation\n\n## Error Handling\n\n### Common Error Responses\n\n```json\n// Invalid or expired OTP\n{\n  \"success\": false,\n  \"message\": \"Invalid or expired OTP\"\n}\n\n// Rate limit exceeded\n{\n  \"success\": false,\n  \"message\": \"Too many OTP requests. Please wait 15 minutes before requesting again.\"\n}\n\n// Email service unavailable (development)\n{\n  \"success\": false,\n  \"message\": \"Email sending failed (development mode)\",\n  \"otp\": \"123456\",\n  \"error\": \"SMTP connection failed\"\n}\n```\n\n## Monitoring and Logging\n\n### Key Metrics to Monitor\n- OTP generation rate\n- Email delivery success rate\n- OTP verification success rate\n- Failed attempt patterns\n- Cleanup job performance\n\n### Log Events\n- OTP generation and storage\n- Email sending attempts\n- OTP verification attempts\n- Rate limit violations\n- Cleanup operations\n\n## Testing\n\n### Development Testing\n\nWhen `NODE_ENV=development`, the system provides additional debugging information:\n\n```json\n{\n  \"success\": false,\n  \"message\": \"Email sending failed (development mode)\",\n  \"otp\": \"123456\",\n  \"error\": \"Detailed error message\"\n}\n```\n\n### API Testing Examples\n\n```bash\n# Test registration\ncurl -X POST http://localhost:3001/auth/register \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"email\":\"test@example.com\",\"password\":\"Test123!\",\"username\":\"testuser\"}'\n\n# Test OTP verification\ncurl -X POST http://localhost:3001/auth/verify-registration-otp \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"email\":\"test@example.com\",\"otp\":\"123456\"}'\n```\n\n## Maintenance\n\n### Scheduled Tasks\n\nImplement these scheduled tasks for optimal performance:\n\n```javascript\n// Cleanup expired OTPs (run every hour)\nconst otpService = require('./src/utils/otp.utils');\nsetInterval(async () => {\n  await otpService.scheduledCleanup();\n}, 60 * 60 * 1000);\n```\n\n### Performance Optimization\n\n1. **Database Indexes**: Ensure proper indexing on OTP table\n2. **Connection Pooling**: Use connection pooling for SMTP\n3. **Template Caching**: Cache compiled email templates\n4. **Rate Limiting**: Implement Redis-based rate limiting for high load\n\n## Migration from Legacy System\n\nThe new OTP system maintains backward compatibility:\n\n- Legacy routes still exist but redirect to OTP flows\n- Existing users can migrate seamlessly\n- Old token-based flows are deprecated but functional\n\n## Support and Troubleshooting\n\n### Common Issues\n\n1. **SMTP Authentication Failed**\n   - Verify credentials\n   - Check app password generation\n   - Ensure 2FA is enabled\n\n2. **OTPs Not Delivered**\n   - Check spam folder\n   - Verify SMTP configuration\n   - Monitor email service logs\n\n3. **Rate Limit Errors**\n   - Wait for cooldown period\n   - Check for automated attacks\n   - Adjust rate limits if needed\n\n### Contact\nFor support, contact: support@50brains.com\n\n---\n\n*Last updated: October 30, 2025*